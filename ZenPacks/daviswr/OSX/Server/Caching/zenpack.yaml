name: ZenPacks.daviswr.OSX.Server.Caching

class_relationships:
  - Products.ZenModel.Device.Device(cachingService) 1:MC CachingService(server)
  - Products.ZenModel.Device.Device(caches) 1:MC Cache(server)
# Can't get Cache components to show if they're contained by the Caching Service
#  - CachingService(caches) 1:MC Cache(cachingService)

classes:
  CachingService:
    base: [zenpacklib.Component]
    label: Caching Service
    plural_label: Caching Service

    properties:
      DataPath:
        label: Path
        type: string
        grid_display: false

      CacheLimit:
        label: Size
        type: int

      ReservedVolumeSpace:
        label: Reserved Space
        short_label: Reserved
        type: int

      CacheUsed:
        label: Used Space
        short_label: Used
        type: int
        datapoint: caching_CacheUsed

      CacheFree:
        label: Free Space
        short_label: Free
        type: int
        datapoint: caching_CacheFree

      Active:
        label: Active
        type: boolean

      Port:
        label: Port
        type: int
        grid_display: false

      RestrictedMedia:
        label: Restricted Media
        type: boolean
        grid_display: false

      LocalSubnetsOnly:
        label: Local Subnets Only
        short_label: Local Only
        type: boolean
        grid_display: false


  Cache:
    base: [zenpacklib.Component]
    label: Cache

    properties:
      MediaType:
        label: Media Type
        type: string
        grid_display: false

      LocalizedType:
        label: Localized Type
        type: string
        grid_display: false

      Language:
        label: Local Language
        type: string
        grid_display: false

      BytesUsed:
        label: Size
        type: int
        datapoint: CacheDetails_BytesUsed


device_classes:
  /:
    remove: false
    templates:
      CachingService:
        targetPythonClass: ZenPacks.daviswr.OSX.Server.Caching.CachingService
        datasources:
          caching:
            type: COMMAND
            usessh: true
            commandTemplate: "/usr/bin/sudo /Applications/Server.app/Contents/ServerRoot/usr/sbin/serveradmin fullstatus caching"
            parser: ZenPacks.daviswr.OSX.Server.Caching.parsers.serveradmin
            cycletime: 60
            component: "${here/id}"
            datapoints:
              CacheFree: GAUGE
              CacheUsed: GAUGE
              RegistrationStatus: GAUGE
              TotalBytesDropped: DERIVE_MIN_0
              TotalBytesImported: DERIVE_MIN_0
              TotalBytesReturned: DERIVE_MIN_0
              TotalBytesStored: DERIVE_MIN_0
              TotalBytesStoredFromOrigin: DERIVE_MIN_0
              TotalBytesStoredFromPeers: DERIVE_MIN_0

        thresholds:
          Registration:
            type: MinMaxThreshold
            enabled: true
            dsnames:
              - caching_RegistrationStatus
            severity: 3
            eventClass: /Status/Update
            minval: 1
            maxval: 1

        graphs:
          DEFAULTS:
            height: 100
            width: 500

          Cache Size:
            units: bytes
            # OS X reports size in powers of 10 rather than 2
            base: false
            miny: 0
            graphpoints:
              DEFAULTS:
                lineType: AREA
                stacked: true
              Used:
                dpName: caching_CacheUsed
                colorindex: 0
              Free:
                dpName: caching_CacheFree
                color: cccccc

          Cache Activity:
            units: bytes/min
            miny: 0
            graphpoints:
              DEFAULTS:
                lineType: LINE
                lineWidth: 2
                rpn: "60,*"
              Returned:
                dpName: caching_TotalBytesReturned
                colorindex: 0
              Stored:
                dpName: caching_TotalBytesStored
                colorindex: 1
              Dropped:
                dpName: caching_TotalBytesDropped
                colorindex: 2

          Cache Sources:
            units: bytes/min
            miny: 0
            graphpoints:
              DEFAULTS:
                lineType: LINE
                lineWidth: 2
                rpn: "60,*"
              Origin:
                dpName: caching_TotalBytesStoredFromOrigin
                colorindex: 0
              Peers:
                dpName: caching_TotalBytesStoredFromPeers
                colorindex: 1
              Imported:
                dpName: caching_TotalBytesImported
                colorindex: 2
            

      Cache:
        targetPythonClass: ZenPacks.daviswr.OSX.Server.Caching.Cache
        datasources:
          CacheDetails:
            type: COMMAND
            usessh: true
            commandTemplate: "/usr/bin/sudo /Applications/Server.app/Contents/ServerRoot/usr/sbin/serveradmin fullstatus caching"
            parser: ZenPacks.daviswr.OSX.Server.Caching.parsers.serveradmin
            cycletime: 60
            component: "${here/id}"
            datapoints:
              BytesUsed: GAUGE

        graphs:
          DEFAULTS:
            height: 100
            width: 500

          Cache Used Space:
            units: bytes
            base: false
            miny: 0
            graphpoints:
              Used Space:
                dpName: CacheDetails_BytesUsed
                lineType: AREA
                colorindex: 0
